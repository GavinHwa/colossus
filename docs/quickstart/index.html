<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Quickstart</title>
    <meta name="viewport" content="width=device-width">
    <meta name="description" content="Colossus IO Framework: Built at Tumblr">
    <link rel="canonical" href="https://github.com/tumblr/colossushttps://tumblr.github.io/colossus/docs/quickstart/">

    <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
    <meta http-equiv="imagetoolbar" content="no" />
    <link rel="stylesheet" href="https://tumblr.github.io/colossus/css/layout.css" type="text/css" />
    <script type="text/javascript" src="https://tumblr.github.io/colossus/js/jquery.js"></script>
    <script type="text/javascript" src="https://tumblr.github.io/colossus/js/jquery.innerfade.js"></script>
    <link href='https://fonts.googleapis.com/css?family=Titillium+Web' rel='stylesheet' type='text/css'>

</head>

</head>


    <body>

    <div class="wrapper col1">
  <div id="header">
    <div id="logo">
      <h1><a href="https://tumblr.github.io/colossus/">Colossus</a></h1>
    </div>
    <div id="topnav">
      <ul>
        <li><a href="https://tumblr.github.io/colossus/about">About</a></li>
        <li><a href="https://tumblr.github.io/colossus/">Community</a></li>
        <li><a href="https://tumblr.github.io/colossus/docs">Documentation</a></li>
        <li><a href="https://github.com/tumblr/colossus">Github</a></li>
      </ul>
    </div>
    <br class="clear" />
  <p class="breaking-news"><b>Notice</b>: These docs are a work in progress.  If you see an error, <a href="https://github.com/tumblr/colossus/tree/gh-pages-source">fix it</a>!</p>
  </div>
</div>



        <div class="wrapper col3">
    <div id="container">
      <header class="post-header">
        <h1>Quickstart</h1>
      </header>
      <div id="content">
        <article class="post-content">
        <p>This guide will get you familiar with Colossus and help you write your first service.</p>

<h2 id="anatomy-of-a-service">Anatomy of a Service</h2>

<p>Before we get to writing code, it will help to understand the basics about what
Colossus is for and how it works.  While Colossus is a fully generalized I/O
framework for building many different types of applications, this guide is
focused on the primary use case, services.  A <strong>Service</strong> is a reactive server
application that receives incoming requests from clients, processes them (often
in parallel), and returns responses.</p>

<p>To be even more specific, Colossus is focused on building <strong>Microservices</strong>,
which generally are stateless, single-feature, RESTful HTTP servers which exist
as part of a larger architecture.</p>

<p>A Colossus application consists of roughly two parts:</p>

<ul>
  <li>A Server that listens on a TCP port and accepts incoming connections</li>
  <li>A set of Workers that provide the environment for processing requests from those connections</li>
</ul>

<p>Workers are where the majority of a service’s business logic is performed.
Workers are reactive event-loops and delegate events to be processed as they are
received.  Generally a service will start one worker per physical CPU core, and
work will be distributed amongst them.</p>

<p>When it comes to writing a service, you supply two components:</p>

<ul>
  <li>An <strong>Initializer</strong>, which is used to hook environment/setup logic into a worker</li>
  <li>A <strong>Request Handler</strong> which is attached to each connection to do your service’s actual work</li>
</ul>

<p>Whenever a Server accepts a new connection, the connection is transferred and
<em>bound</em> to one of the workers.  The binding process consists of attaching the
connection to the Worker’s event-loop and creating a request handler that reacts
to events generated by the connection (such as when new data is available to read or the
connection closes).  It is in this request handler where most of the service’s
user-code lives.</p>

<h2 id="build-a-hello-world-service">Build a Hello World Service</h2>

<p>Add the following to your Build.scala or build.sbt:</p>

<div class="highlight"><pre><code class="scala"><span class="n">libraryDependencies</span> <span class="o">+=</span> <span class="s">"com.tumblr"</span> <span class="o">%%</span> <span class="s">"colossus"</span> <span class="o">%</span> <span class="s">"0.8.1"</span></code></pre></div>

<p>Colossus is compiled for Scala 2.10 and 2.11 and built against Akka 2.3.</p>

<p>We’ll start with a simple “hello world” http service written in a fairly verbose
manner to make things easy to follow:</p>

<div class="highlight"><pre><code class="scala"><span class="k">import</span> <span class="nn">colossus._</span>
<span class="k">import</span> <span class="nn">core._</span>
<span class="k">import</span> <span class="nn">service._</span>
<span class="k">import</span> <span class="nn">protocols.http._</span>
<span class="k">import</span> <span class="nn">UrlParsing._</span>
<span class="k">import</span> <span class="nn">HttpMethod._</span>

<span class="k">class</span> <span class="nc">HelloService</span><span class="o">(</span><span class="n">context</span><span class="k">:</span> <span class="kt">ServerContext</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">HttpService</span><span class="o">(</span><span class="n">context</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">handle</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">case</span> <span class="n">request</span> <span class="k">@</span> <span class="nc">Get</span> <span class="n">on</span> <span class="nc">Root</span> <span class="o">/</span> <span class="s">"hello"</span> <span class="k">=&gt;</span> <span class="o">{</span>
      <span class="nc">Callback</span><span class="o">.</span><span class="n">successful</span><span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="n">ok</span><span class="o">(</span><span class="s">"Hello World!"</span><span class="o">))</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="k">class</span> <span class="nc">HelloInitializer</span><span class="o">(</span><span class="n">worker</span><span class="k">:</span> <span class="kt">WorkerRef</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Initializer</span><span class="o">(</span><span class="n">worker</span><span class="o">)</span> <span class="o">{</span>
  
  <span class="k">def</span> <span class="n">onConnect</span> <span class="k">=</span> <span class="n">context</span> <span class="k">=&gt;</span> <span class="k">new</span> <span class="nc">HelloService</span><span class="o">(</span><span class="n">context</span><span class="o">)</span>

<span class="o">}</span>


<span class="k">object</span> <span class="nc">Main</span> <span class="k">extends</span> <span class="nc">App</span> <span class="o">{</span>

  <span class="k">implicit</span> <span class="k">val</span> <span class="n">actorSystem</span> <span class="k">=</span> <span class="nc">ActorSystem</span><span class="o">()</span>
  <span class="k">implicit</span> <span class="k">val</span> <span class="n">io</span> <span class="k">=</span> <span class="nc">IOSystem</span><span class="o">()</span>

  <span class="nc">Server</span><span class="o">.</span><span class="n">start</span><span class="o">(</span><span class="s">"hello-world"</span><span class="o">,</span> <span class="mi">9000</span><span class="o">){</span> <span class="n">worker</span> <span class="k">=&gt;</span> <span class="k">new</span> <span class="nc">HelloInitializer</span><span class="o">(</span><span class="n">worker</span><span class="o">)</span> <span class="o">}</span>

<span class="o">}</span></code></pre></div>

<p>This will start a basic http server on port 9000:</p>

<div class="highlight"><pre><code class="plaintext">&gt; curl localhost:9000
Hello World! (200 OK)

&gt; curl localhost:9000/foo
No route for /foo (404 Not Found)</code></pre></div>

<h3 id="a-closer-look">A Closer Look</h3>

<p>Let’s look at this code piece-by-piece.</p>

<div class="highlight"><pre><code class="scala"><span class="k">class</span> <span class="nc">HelloService</span><span class="o">(</span><span class="n">context</span><span class="k">:</span> <span class="kt">ServerContext</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">HttpService</span><span class="o">(</span><span class="n">context</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">handle</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">case</span> <span class="n">request</span> <span class="k">@</span> <span class="nc">Get</span> <span class="n">on</span> <span class="nc">Root</span> <span class="o">/</span> <span class="s">"hello"</span> <span class="k">=&gt;</span> <span class="o">{</span>
      <span class="nc">Callback</span><span class="o">.</span><span class="n">successful</span><span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="n">ok</span><span class="o">(</span><span class="s">"Hello World!"</span><span class="o">))</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></div>

<p>This defines the request handler for the service.  A new request handler is
attached to every connection and does all of the actual request processing.  </p>

<p>The <code>handle</code> partial function is where request processing actually happens.  In
it, incoming <code>HttpRequest</code> objects are mapped to <code>HttpResponse</code>.</p>

<p>Notice that the return value of <code>handle</code> is of type <code>Callback[HttpResponse]</code>.
Callbacks are the concurrency mechanism Colossus provides to do non-blocking
operations.  They are similar to Scala Futures in their use, but their execution
is entirely single-threaded and managed by the Worker.  Since in this example,
no actual concurrency is required, <code>Callback.successful</code> simply wraps our final
result in a Callback.</p>

<div class="highlight"><pre><code class="scala"><span class="k">class</span> <span class="nc">HelloInitializer</span><span class="o">(</span><span class="n">worker</span><span class="k">:</span> <span class="kt">WorkerRef</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Initializer</span><span class="o">(</span><span class="n">worker</span><span class="o">)</span> <span class="o">{</span>
  
  <span class="k">def</span> <span class="n">onConnect</span> <span class="k">=</span> <span class="n">context</span> <span class="k">=&gt;</span> <span class="k">new</span> <span class="nc">HelloService</span><span class="o">(</span><span class="n">context</span><span class="o">)</span>

<span class="o">}</span></code></pre></div>

<p>The <code>Initializer</code> is a long-lived object that is created once per Worker and
manages the service’s environment within the worker.  Because Workers are
single-threaded, Initializers provide a place to share resources among all
connections handled by the worker.  In particular this is often where
outgoing connections to external services can be opened.</p>

<p>Initializers also are responsible for providing new connections with request
handlers.  This is how our <code>HelloService</code> handler is created.  We provide
Colossus with a function of type <code>ServerContext =&gt; ServerConnectionHandler</code> and
it gets used like a factory.</p>

<p>Lastly, let’s look at the bootstrap code to get the service running</p>

<div class="highlight"><pre><code class="scala"><span class="k">implicit</span> <span class="k">val</span> <span class="n">actorSystem</span> <span class="k">=</span> <span class="nc">ActorSystem</span><span class="o">()</span>
<span class="k">implicit</span> <span class="k">val</span> <span class="n">io</span> <span class="k">=</span> <span class="nc">IOSystem</span><span class="o">()</span></code></pre></div>

<p>An <code>IOSystem</code> is a collection of Workers with a thin management layer on top.
Servers do not manage their own workers, but instead attach to an IOSystem and
let the system do all the Worker management.  Likewise, on its own, an
IOSystem does nothing and its workers sit idle.</p>

<p>Because an <code>IOSystem</code> is really just a set of Akka actors, it requires an <code>ActorSystem</code> to start.</p>

<div class="highlight"><pre><code class="scala"><span class="nc">Server</span><span class="o">.</span><span class="n">start</span><span class="o">(</span><span class="s">"hello-world"</span><span class="o">,</span> <span class="mi">9000</span><span class="o">){</span> <span class="n">worker</span> <span class="k">=&gt;</span> <span class="k">new</span> <span class="nc">HelloInitializer</span><span class="o">(</span><span class="n">worker</span><span class="o">)</span> <span class="o">}</span></code></pre></div>

<p>This starts a Server that will listen on port 9000.  The important part here is
the third argument, which is a function of type <code>WorkerRef =&gt; Initializer</code>.
This is a function that will be sent to every Worker in the IOSystem to
initialize it, so every worker will call this function once, passing itself in
as an argumnent.</p>

<h2 id="working-with-clients">Working with Clients</h2>

<p>In our next example we’ll write a simple HTTP frontend for Redis.  One of the
driving features of Colossus is the ability to do low-latency non-blocking
interactions with external systems.  Redis, being an in-memory database, is an
ideal candidate for the kinds of systems Colossus works best with.  </p>

<p>While Colossus services can easily be built to communicate with any system such
as a SQL database, it currently has native support for Redis, Memcached, and
HTTP clients.  Colossus is protocol agnostic, so writing native adapters for
any protocol is easy.</p>

<div class="highlight"><pre><code class="scala"><span class="nc">Server</span><span class="o">.</span><span class="n">start</span><span class="o">(</span><span class="s">"redis-http"</span><span class="o">,</span> <span class="mi">9000</span><span class="o">){</span> <span class="k">new</span> <span class="nc">Initializer</span><span class="o">(</span><span class="k">_</span><span class="o">)</span> <span class="o">{</span>
  
  <span class="k">val</span> <span class="n">redisClient</span> <span class="k">=</span> <span class="nc">Redis</span><span class="o">.</span><span class="n">client</span><span class="o">(</span><span class="s">"localhost"</span><span class="o">,</span> <span class="mi">6379</span><span class="o">)</span>

  <span class="k">def</span> <span class="n">onConnect</span> <span class="k">=</span> <span class="n">context</span> <span class="k">=&gt;</span> <span class="k">new</span> <span class="nc">HttpService</span><span class="o">(</span><span class="n">context</span><span class="o">){</span>
    <span class="k">def</span> <span class="n">handle</span> <span class="k">=</span> <span class="o">{</span>
      <span class="k">case</span> <span class="n">req</span> <span class="k">@</span> <span class="nc">Get</span> <span class="n">on</span> <span class="nc">Root</span> <span class="o">/</span> <span class="s">"get"</span> <span class="o">/</span> <span class="n">key</span> <span class="k">=&gt;</span> <span class="o">{</span>
        <span class="n">redisClient</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="n">key</span><span class="o">).</span><span class="n">map</span><span class="o">{</span>
          <span class="k">case</span> <span class="nc">Some</span><span class="o">(</span><span class="n">data</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">req</span><span class="o">.</span><span class="n">ok</span><span class="o">(</span><span class="n">data</span><span class="o">.</span><span class="n">utf8String</span><span class="o">)</span>
          <span class="k">case</span> <span class="nc">None</span>       <span class="k">=&gt;</span> <span class="n">req</span><span class="o">.</span><span class="n">notFound</span><span class="o">(</span><span class="s">"(N/A)"</span><span class="o">)</span>
        <span class="o">}</span>
      <span class="o">}</span>

      <span class="k">case</span> <span class="n">req</span> <span class="k">@</span> <span class="nc">Get</span> <span class="n">on</span> <span class="nc">Root</span> <span class="o">/</span> <span class="s">"set"</span> <span class="o">/</span> <span class="n">key</span> <span class="o">/</span> <span class="n">value</span> <span class="k">=&gt;</span> <span class="o">{</span>
        <span class="n">redisClient</span><span class="o">.</span><span class="n">set</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">value</span><span class="o">).</span><span class="n">map</span><span class="o">{</span><span class="k">_</span> <span class="k">=&gt;</span> <span class="n">req</span><span class="o">.</span><span class="n">ok</span><span class="o">(</span><span class="s">"OK"</span><span class="o">)}</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}}</span></code></pre></div>

<p>Here, we create a <code>ServiceClient</code> using the redis protocol in the service’s
<code>Initializer</code>.  This means that one connection to Redis is opened per Worker,
and all connections handled by that worker will use this client.  Again, since
everything here is per-worker and hence single-threaded, there are no issues
with many request handlers using the same redis client. </p>

<p>This gives us a service that conceptually looks like:</p>

<p><img src="https://tumblr.github.io/colossus/img/redis.png" alt="redis" /></p>

<p>The client’s <code>send</code> method returns a <code>Callback[Reply]</code> that can be mapped and
flatMapped just like a regular Scala Future.  In fact Callbacks implement most
of the same methods as Futures, including <code>recover</code> and <code>sequence</code>.</p>

<h2 id="working-with-futures">Working with Futures</h2>

<p>So far all the request-handling code we’ve seen has been effectively
single-threaded.  Even though our service has multiple workers running in
parallel, everything in the context of a single request handler is
single-threaded.</p>

<p>Sometimes this is not what we want.  If processing a request involves either
performing some CPU intensive operation or using a blocking API, the Worker’s
event-loop will get stuck waiting, causing high latency on any other connections
that happen to be bound to it.  In other cases, we need all our request handlers
interacting with some form of shared state.</p>

<p>Consider this service:</p>

<div class="highlight"><pre><code class="scala"><span class="k">def</span> <span class="n">fibonacci</span><span class="o">(</span><span class="n">i</span><span class="k">:</span> <span class="kt">Long</span><span class="o">)</span><span class="k">:</span> <span class="kt">Long</span> <span class="o">=</span> <span class="n">i</span> <span class="k">match</span> <span class="o">{</span>
  <span class="k">case</span> <span class="mi">1</span> <span class="o">|</span> <span class="mi">2</span> <span class="k">=&gt;</span> <span class="mi">1</span>
  <span class="k">case</span> <span class="n">n</span> <span class="k">=&gt;</span> <span class="n">fibonacci</span><span class="o">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)</span> <span class="o">+</span> <span class="n">fibonacci</span><span class="o">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">2</span><span class="o">)</span>
<span class="o">}</span>

<span class="k">implicit</span> <span class="k">val</span> <span class="n">io</span> <span class="k">=</span> <span class="nc">IOSystem</span><span class="o">(</span><span class="n">numWorkers</span> <span class="k">=</span> <span class="mi">1</span><span class="o">)</span>

<span class="nc">Server</span><span class="o">.</span><span class="n">basic</span><span class="o">(</span><span class="s">"fibonacci"</span><span class="o">,</span> <span class="mi">9000</span><span class="o">){</span> <span class="k">new</span> <span class="nc">HttpService</span><span class="o">(</span><span class="k">_</span><span class="o">)</span> <span class="o">{</span>

  <span class="k">def</span> <span class="n">handle</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">case</span> <span class="n">req</span> <span class="k">@</span> <span class="nc">Get</span> <span class="n">on</span> <span class="nc">Root</span> <span class="o">/</span> <span class="s">"hello"</span> <span class="k">=&gt;</span> <span class="o">{</span>
      <span class="nc">Callback</span><span class="o">.</span><span class="n">successful</span><span class="o">(</span><span class="s">"Hello World!"</span><span class="o">)</span>
    <span class="o">}</span>

    <span class="k">case</span> <span class="n">req</span> <span class="k">@</span> <span class="nc">Get</span> <span class="n">on</span> <span class="nc">Root</span> <span class="o">/</span> <span class="s">"fib"</span> <span class="o">/</span> <span class="nc">Long</span><span class="o">(</span><span class="n">n</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="k">if</span> <span class="o">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">Callback</span><span class="o">.</span><span class="n">successful</span><span class="o">(</span><span class="n">req</span><span class="o">.</span><span class="n">ok</span><span class="o">(</span><span class="n">fibonacci</span><span class="o">(</span><span class="n">n</span><span class="o">).</span><span class="n">toString</span><span class="o">))</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="nc">Callback</span><span class="o">.</span><span class="n">successful</span><span class="o">(</span><span class="n">req</span><span class="o">.</span><span class="n">badRequest</span><span class="o">(</span><span class="s">"number must be positive"</span><span class="o">))</span>
    <span class="o">}</span>
  <span class="o">}</span>

<span class="o">}}</span></code></pre></div>

<p>By starting an IOSystem with just one Worker, we can be sure all connections are
being handled by the same worker.  Now if you hit the url <code>/fib/1000000</code>, it
will take the server quite a while to calculate this.  But since this is
happening in the worker’s thread, no other request handling can happen and all
other requests to the server, even those to the <code>/hello</code> route, will be blocked
until it completes.</p>

<p>The best way to avoid this situation is to offload the calculation to a separate thread using Sala Futures.  This is easy to do using <code>Callback.fromFuture</code>:</p>

<div class="highlight"><pre><code class="scala"><span class="k">def</span> <span class="n">fibonacci</span><span class="o">(</span><span class="n">i</span><span class="k">:</span> <span class="kt">Long</span><span class="o">)</span><span class="k">:</span> <span class="kt">Long</span> <span class="o">=</span> <span class="n">i</span> <span class="k">match</span> <span class="o">{</span>
  <span class="k">case</span> <span class="mi">1</span> <span class="o">|</span> <span class="mi">2</span> <span class="k">=&gt;</span> <span class="mi">1</span>
  <span class="k">case</span> <span class="n">n</span> <span class="k">=&gt;</span> <span class="n">fibonacci</span><span class="o">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)</span> <span class="o">+</span> <span class="n">fibonacci</span><span class="o">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">2</span><span class="o">)</span>
<span class="o">}</span>

<span class="k">def</span> <span class="n">futureFibonacci</span><span class="o">(</span><span class="n">i</span><span class="k">:</span> <span class="kt">Long</span><span class="o">)</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">Long</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Future</span> <span class="o">{</span> <span class="n">fibonacci</span><span class="o">(</span><span class="n">i</span><span class="o">)</span> <span class="o">}</span>

<span class="k">implicit</span> <span class="k">val</span> <span class="n">io</span> <span class="k">=</span> <span class="nc">IOSystem</span><span class="o">(</span><span class="n">numWorkers</span> <span class="k">=</span> <span class="mi">1</span><span class="o">)</span>

<span class="nc">Server</span><span class="o">.</span><span class="n">basic</span><span class="o">(</span><span class="s">"fibonacci"</span><span class="o">,</span> <span class="mi">9000</span><span class="o">){</span> <span class="k">new</span> <span class="nc">HttpService</span><span class="o">(</span><span class="k">_</span><span class="o">)</span> <span class="o">{</span>

  <span class="k">def</span> <span class="n">handle</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">case</span> <span class="n">req</span> <span class="k">@</span> <span class="nc">Get</span> <span class="n">on</span> <span class="nc">Root</span> <span class="o">/</span> <span class="s">"hello"</span> <span class="k">=&gt;</span> <span class="o">{</span>
      <span class="nc">Callback</span><span class="o">.</span><span class="n">successful</span><span class="o">(</span><span class="s">"Hello World!"</span><span class="o">)</span>
    <span class="o">}</span>

    <span class="k">case</span> <span class="n">req</span> <span class="k">@</span> <span class="nc">Get</span> <span class="n">on</span> <span class="nc">Root</span> <span class="o">/</span> <span class="s">"fib"</span> <span class="o">/</span> <span class="nc">Long</span><span class="o">(</span><span class="n">n</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="k">if</span> <span class="o">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">Callback</span><span class="o">.</span><span class="n">fromFuture</span><span class="o">(</span><span class="n">fibonacciFuture</span><span class="o">(</span><span class="n">n</span><span class="o">)).</span><span class="n">map</span> <span class="o">{</span> <span class="n">result</span> <span class="k">=&gt;</span>
        <span class="n">req</span><span class="o">.</span><span class="n">ok</span><span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="n">toString</span><span class="o">)</span>
      <span class="o">}</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="nc">Callback</span><span class="o">.</span><span class="n">successful</span><span class="o">(</span><span class="n">req</span><span class="o">.</span><span class="n">badRequest</span><span class="o">(</span><span class="s">"number must be positive"</span><span class="o">))</span>
    <span class="o">}</span>
  <span class="o">}</span>

<span class="o">}}</span></code></pre></div>

<p>This will let the calculation of the result happen in another thread, and once
the Future is complete, execution will be moved back into the Worker and the
response will be built and sent back to the client.</p>

<p>Of course, this works even when a connection is pipelining multiple requests at
the same time on a single connection.  Colossus will continue to process
incoming requests even while it is waiting for existing ones to complete, making
it easy to parallelize work.</p>

<p>Lastly, let’s add some caching to this service by using Memcached</p>

<div class="highlight"><pre><code class="scala"><span class="nc">Server</span><span class="o">.</span><span class="n">start</span><span class="o">(</span><span class="s">"fibonacci"</span><span class="o">,</span> <span class="mi">9000</span><span class="o">){</span> <span class="k">new</span> <span class="nc">Initializer</span><span class="o">(</span><span class="k">_</span><span class="o">)</span> <span class="o">{</span>

  <span class="k">val</span> <span class="n">cache</span> <span class="k">=</span> <span class="nc">Memcache</span><span class="o">.</span><span class="n">client</span><span class="o">(</span><span class="s">"memcached.foo.bar"</span><span class="o">,</span> <span class="mi">11211</span><span class="o">)</span>

  <span class="k">def</span> <span class="n">onConnect</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">HttpService</span><span class="o">(</span><span class="k">_</span><span class="o">)</span> <span class="o">{</span>

    <span class="k">def</span> <span class="n">handle</span> <span class="k">=</span> <span class="o">{</span>
      <span class="k">case</span> <span class="n">req</span> <span class="k">@</span> <span class="nc">Get</span> <span class="n">on</span> <span class="nc">Root</span> <span class="o">/</span> <span class="s">"hello"</span> <span class="k">=&gt;</span> <span class="o">{</span>
        <span class="nc">Callback</span><span class="o">.</span><span class="n">successful</span><span class="o">(</span><span class="s">"Hello World!"</span><span class="o">)</span>
      <span class="o">}</span>

      <span class="k">case</span> <span class="n">req</span> <span class="k">@</span> <span class="nc">Get</span> <span class="n">on</span> <span class="nc">Root</span> <span class="o">/</span> <span class="s">"fib"</span> <span class="o">/</span> <span class="nc">Long</span><span class="o">(</span><span class="n">n</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="k">if</span> <span class="o">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="n">s</span><span class="s">"fib_$n"</span><span class="o">).</span><span class="n">flatMap</span><span class="o">{</span>
          <span class="k">case</span> <span class="nc">Some</span><span class="o">(</span><span class="n">value</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">req</span><span class="o">.</span><span class="n">ok</span><span class="o">(</span><span class="n">value</span><span class="o">.</span><span class="n">utf8String</span><span class="o">)</span>
          <span class="k">case</span> <span class="nc">None</span> <span class="k">=&gt;</span> <span class="k">for</span> <span class="o">{</span>
            <span class="n">result</span>    <span class="k">&lt;-</span> <span class="nc">Callback</span><span class="o">.</span><span class="n">fromFuture</span><span class="o">(</span><span class="n">fibonacciFuture</span><span class="o">(</span><span class="n">n</span><span class="o">))</span>
            <span class="n">cacheSet</span>  <span class="k">&lt;-</span> <span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="o">(</span><span class="n">s</span><span class="s">"fib_$n"</span><span class="o">,</span> <span class="nc">ByteString</span><span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="n">toString</span><span class="o">))</span>
          <span class="o">}</span> <span class="k">yield</span> <span class="n">req</span><span class="o">.</span><span class="n">ok</span><span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="n">toString</span><span class="o">)</span>
        <span class="o">}</span>
      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="nc">Callback</span><span class="o">.</span><span class="n">successful</span><span class="o">(</span><span class="n">req</span><span class="o">.</span><span class="n">badRequest</span><span class="o">(</span><span class="s">"number must be positive"</span><span class="o">))</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>

<span class="o">}}</span></code></pre></div>

<p>In this case, all of the memcached interactions are still happening entirely in
the worker’s thread, with cache misses being offloaded to another thread to keep
the event loop unblocked.  On modern hardware, this service could easily handle
hundreds of thousands of requests per second.</p>


        </article>
      </div>
      <div id="column">
        <div class="subnav">
          <ol class="toc"><li><a href="#anatomy-of-a-service">Anatomy of a Service</a></li><li><a href="#build-a-hello-world-service">Build a Hello World Service</a></li><li><a href="#working-with-clients">Working with Clients</a></li><li><a href="#working-with-futures">Working with Futures</a></li></ol>
        </div>
      </div>
      <br class="clear" />
    </div>
  </div>
  <br class="clear" />



    <footer id = "footer" class="site-footer">

<div class="wrapper col5">
  <div id="copyright">
    <p class="fl_left">Copyright &copy; 2016 Tumblr - All Rights Reserved <a rel="license" href="http://creativecommons.org/licenses/by/3.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by/3.0/80x15.png" /></a></p>
    <p class="fl_right">Based on a template by <a href="http://www.os-templates.com/" title="Free Website Templates">OS Templates</a></p>
    <br class="clear" />
  </div>
</div>

</footer>


    </body>
</html>
