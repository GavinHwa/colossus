<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Metrics</title>
    <meta name="viewport" content="width=device-width">
    <meta name="description" content="Colossus IO Framework: Built at Tumblr">
    <link rel="canonical" href="https://github.com/tumblr/colossushttps://tumblr.github.io/colossus/docs/metrics/">

    <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
    <meta http-equiv="imagetoolbar" content="no" />
    <link rel="stylesheet" href="https://tumblr.github.io/colossus/css/layout.css" type="text/css" />
    <script type="text/javascript" src="https://tumblr.github.io/colossus/js/jquery.js"></script>
    <script type="text/javascript" src="https://tumblr.github.io/colossus/js/jquery.innerfade.js"></script>
    <link href='https://fonts.googleapis.com/css?family=Titillium+Web' rel='stylesheet' type='text/css'>

</head>

</head>


    <body>

    <div class="wrapper col1">
  <div id="header">
    <div id="logo">
      <h1><a href="https://tumblr.github.io/colossus/">Colossus</a></h1>
    </div>
    <div id="topnav">
      <ul>
        <li><a href="https://tumblr.github.io/colossus/about">About</a></li>
        <li><a href="https://tumblr.github.io/colossus/">Community</a></li>
        <li><a href="https://tumblr.github.io/colossus/docs">Documentation</a></li>
        <li><a href="https://github.com/tumblr/colossus">Github</a></li>
      </ul>
    </div>
    <br class="clear" />
  <p class="breaking-news"><b>Notice</b>: These docs are a work in progress.  If you see an error, <a href="https://github.com/tumblr/colossus/tree/gh-pages-source">fix it</a>!</p>
  </div>
</div>



        <div class="wrapper col3">
    <div id="container">
      <header class="post-header">
        <h1>Metrics</h1>
      </header>
      <div id="content">
        <article class="post-content">
        <p>Colossus uses the (currently nameless) metrics library.</p>

<h2 id="introduction">Introduction</h2>

<p>High-throughput Colossus services can serve hundreds of thousands of requests
per second, which can easily translate to millions of recordable events per
second.  The Metrics library provides a way to work with metrics with as little
overhead as possible. It is configurable via a <a href="https://github.com/typesafehub/config">typesafe config</a>.
See <a href="https://github.com/tumblr/colossus/blob/master/colossus-metrics/src/main/resources/reference.conf">reference config</a>
The Colossus server and clients define several metrics be default.</p>

<h3 id="collection-intervals">Collection Intervals</h3>

<p>Collection intervals define how often the raw data from all event collectors
are snapshotted and merged together into a single database of values.</p>

<p>The provided config creates a metric system with both 1 second and 1 minute
collection intervals.  The 1 second interval is used to show
real-time metrics where rates and histograms are all showing values reflective
of the last second of activity, whereas the 1 minute intervals are used for
reporting values to an external database in which case the values reported are
all reflective of the last minute of activity.</p>

<h3 id="default-metrics-in-colossus">Default Metrics in Colossus</h3>

<p>Running the Colossus Client and Colossus Server makes several metrics available
in a default service, the server is prefixed with the service name, the client
is prefixed with the service name AND the client name</p>

<h4 id="server">Server</h4>

<table>
  <thead>
    <tr>
      <th>metric name</th>
      <th>Description</th>
      <th>Tags</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>system/fd_count</strong></td>
      <td>the open file descriptor counts</td>
      <td>N/A</td>
    </tr>
    <tr>
      <td><strong>system/gc/cycles</strong></td>
      <td>number of garbage collection cycles</td>
      <td>type : ConcurrentMarkSweep, ParNew</td>
    </tr>
    <tr>
      <td><strong>system/gc/msec</strong></td>
      <td>the milliseconds it takes for garbage collection</td>
      <td>type : ConcurrentMarkSweep, ParNew</td>
    </tr>
    <tr>
      <td><strong>system/memory</strong></td>
      <td>the total memory availble to the JVM</td>
      <td>type: free, max, allocated</td>
    </tr>
    <tr>
      <td><strong>requests</strong></td>
      <td>the amount of request to the service</td>
      <td>status_code: http code(example: 201, 400)</td>
    </tr>
    <tr>
      <td><strong>concurrent_requests</strong></td>
      <td>the amount of request to the service in a time interval</td>
      <td>N/A</td>
    </tr>
    <tr>
      <td><strong>requests_per_connection</strong></td>
      <td>the amount of different async requests made in a single request</td>
      <td>label: max, mean, etc</td>
    </tr>
    <tr>
      <td><strong>errors</strong></td>
      <td>the amount of exceptionst that have bubbled up in the service</td>
      <td>type: exception name</td>
    </tr>
    <tr>
      <td><strong>latency</strong></td>
      <td>the time (in ms) it takes to complete a request</td>
      <td>label:max,mean, etc  status_code:200, 404, etc</td>
    </tr>
    <tr>
      <td><strong>worker/event_loops</strong></td>
      <td>how many event loops were selected in a given interval</td>
      <td>worker: the worker Id for a given event loop</td>
    </tr>
    <tr>
      <td><strong>worker/connections</strong></td>
      <td>the connections registrered for a new or reconnecting client</td>
      <td>worker: the worker Id for a given event loop</td>
    </tr>
    <tr>
      <td><strong>worker/rejected_connections</strong></td>
      <td>the number of connections that weren’t able to be created by the worker</td>
      <td>server: servername, worker: worker id</td>
    </tr>
    <tr>
      <td><strong>connections</strong></td>
      <td>the amount of connections that are used for work</td>
      <td>N/A</td>
    </tr>
    <tr>
      <td><strong>refused_connections</strong></td>
      <td>the amount of connections that were rejected due to the connection limiter</td>
      <td>N/A</td>
    </tr>
    <tr>
      <td><strong>connects</strong></td>
      <td>the amount of connections attempted, this includes both connections and refused_connections</td>
      <td>N/A</td>
    </tr>
    <tr>
      <td><strong>closed</strong></td>
      <td>the number of connections that are closed</td>
      <td>cause: string for the connection closing</td>
    </tr>
    <tr>
      <td><strong>highwaters</strong></td>
      <td>the amount threads that have changed connection state (normal or highwater_</td>
      <td>N/A</td>
    </tr>
  </tbody>
</table>

<h4 id="client">Client</h4>

<table>
  <thead>
    <tr>
      <th>metric name</th>
      <th>Description</th>
      <th>Tags</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>requests</strong></td>
      <td>the amount of requests the client made</td>
      <td>client_port: the port in use</td>
    </tr>
    <tr>
      <td><strong>errors</strong></td>
      <td>the exceptions that bubbled up to the client</td>
      <td>type: the exception</td>
    </tr>
    <tr>
      <td><strong>dropped_requests</strong></td>
      <td>the number of requests that cannot be sent back to the client</td>
      <td>client_port: the port in use</td>
    </tr>
    <tr>
      <td><strong>connection_failures</strong></td>
      <td>if a connection failed to an external host</td>
      <td>client_port: the port in use</td>
    </tr>
    <tr>
      <td><strong>disconnects</strong></td>
      <td>if a connection is lost due to being closed, that isn’t a connection failure (example: connection closed)</td>
      <td>client_port</td>
    </tr>
    <tr>
      <td><strong>latency</strong></td>
      <td>the time (in ms) it takes to complete a request, this includes time in the queue</td>
      <td>label:max,mean, etc  client_port: the port in use</td>
    </tr>
    <tr>
      <td><strong>transit_time</strong></td>
      <td>the time (in ms) it takes to complete a request, this does NOT include queue time</td>
      <td>label:max,mean, etc  client_port: the port in use</td>
    </tr>
    <tr>
      <td><strong>queue_time</strong></td>
      <td>the time between a request is made to when the call is made</td>
      <td>label:max,mean, etc  client_port: the port in use</td>
    </tr>
  </tbody>
</table>

<h3 id="metric-filters">Metric Filters</h3>

<h3 id="metric-addresses-and-tags">Metric Addresses and Tags</h3>

<p>Every metric has a url-like address used to identify it.</p>

<p>One of the most important aspects of metrics is that values can be tagged.  For
example, a rate can track hits to API endpoints, using a “endpoint” tag to break
down the usage by endpoint.</p>

<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">val</span> <span class="n">rate</span> <span class="k">=</span> <span class="nc">Rate</span><span class="o">(</span><span class="s">"my-rate"</span><span class="o">)</span>
<span class="n">rate</span><span class="o">.</span><span class="n">hit</span><span class="o">(</span><span class="nc">Map</span><span class="o">(</span><span class="s">"endpoint"</span> <span class="o">-&gt;</span> <span class="s">"foo"</span><span class="o">))</span>
<span class="n">rate</span><span class="o">.</span><span class="n">hit</span><span class="o">(</span><span class="nc">Map</span><span class="o">(</span><span class="s">"endpoint"</span> <span class="o">-&gt;</span> <span class="s">"bar"</span><span class="o">))</span>
<span class="n">rate</span><span class="o">.</span><span class="n">hit</span><span class="o">(</span><span class="nc">Map</span><span class="o">(</span><span class="s">"endpoint"</span> <span class="o">-&gt;</span> <span class="s">"bar"</span><span class="o">))</span></code></pre></figure>

<p>This will in turn lead to</p>

<table>
  <thead>
    <tr>
      <th>endpoint</th>
      <th>value</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>foo</td>
      <td>1</td>
    </tr>
    <tr>
      <td>bar</td>
      <td>2</td>
    </tr>
  </tbody>
</table>

<h2 id="getting-started">Getting Started</h2>

<p>If you are using colossus, it depends on the metrics library and pulls it in.
Otherwise you must add the following to your build.sbt/Build.scala</p>

<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="n">libraryDependencies</span> <span class="o">+=</span> <span class="s">"com.tumblr"</span> <span class="o">%%</span> <span class="s">"colossus-metrics"</span> <span class="o">%</span> <span class="s">"0.8.3"</span></code></pre></figure>

<p>From there, the only required step is to spin up a <code class="highlighter-rouge">MetricSystem</code></p>

<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">import</span> <span class="nn">akka.actor._</span>
<span class="k">import</span> <span class="nn">metrics._</span>

<span class="k">implicit</span> <span class="k">val</span> <span class="n">actorSystem</span> <span class="k">=</span> <span class="nc">ActorSystem</span><span class="o">()</span>

<span class="c1">//create the metric system from a typesafe config
</span><span class="k">implicit</span> <span class="k">val</span> <span class="n">metricSystem</span> <span class="k">=</span> <span class="nc">MetricSystem</span><span class="o">(</span><span class="nc">MetricSystemConfig</span><span class="o">.</span><span class="n">load</span><span class="o">(</span><span class="s">"application"</span><span class="o">))</span>

<span class="k">val</span> <span class="n">rate</span> <span class="k">=</span> <span class="nc">Rate</span><span class="o">(</span><span class="s">"my-rate"</span><span class="o">)</span>

<span class="n">rate</span><span class="o">.</span><span class="n">hit</span><span class="o">()</span></code></pre></figure>

<h3 id="namespaces">Namespaces</h3>

<p>When creating a new collector, you always need an implicit <code class="highlighter-rouge">MetricNamespace</code> in
scope.  The <code class="highlighter-rouge">MetricSystem</code> itself acts as the root namespace, but you can use it
to create sub-namespaces:</p>

<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">val</span> <span class="n">metricSystem</span> <span class="k">=</span> <span class="nc">MetricSystem</span><span class="o">()</span>

<span class="k">implicit</span> <span class="k">val</span> <span class="n">namespace</span> <span class="k">=</span> <span class="n">metricSystem</span> <span class="o">/</span> <span class="s">"foo"</span> <span class="o">/</span> <span class="s">"bar"</span>

<span class="c1">//this rate will have the address "/foo/bar/baz"
</span><span class="k">val</span> <span class="n">rate</span> <span class="k">=</span> <span class="nc">Rate</span><span class="o">(</span><span class="s">"baz"</span><span class="o">)</span></code></pre></figure>

<h3 id="metric-tick-complete-example">Metric Tick Complete example</h3>

<p>The example below illustrates creating a service with a url called badUrl and
doing a metric tick when an endpoint is hit.</p>

<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">implicit</span> <span class="k">val</span> <span class="n">ac</span> <span class="k">=</span> <span class="nc">ActorSystem</span><span class="o">(</span><span class="s">"badearl"</span><span class="o">)</span>
  <span class="k">val</span> <span class="n">metricSystem</span> <span class="k">=</span> <span class="nc">MetricSystem</span><span class="o">(</span><span class="s">"badurl"</span><span class="o">)</span> <span class="c1">//defaults in MetricSystemConfig
</span>  <span class="k">val</span> <span class="n">reporterConfig</span> <span class="k">=</span> <span class="nc">MetricReporterConfig</span><span class="o">(</span>
    <span class="n">metricSenders</span> <span class="k">=</span> <span class="nc">OpenTsdbSender</span><span class="o">(</span><span class="s">"myhost"</span><span class="o">,</span> <span class="mi">4242</span><span class="o">)</span> <span class="o">::</span> <span class="nc">Nil</span><span class="o">,</span>
    <span class="n">filters</span> <span class="k">=</span> <span class="nc">MetricReporterFilter</span><span class="o">.</span><span class="nc">All</span>
  <span class="o">)</span>

  <span class="n">metricSystem</span><span class="o">.</span><span class="n">collectionIntervals</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="mf">1.</span><span class="n">minute</span><span class="o">).</span><span class="n">foreach</span><span class="o">{</span>
    <span class="k">_</span><span class="o">.</span><span class="n">report</span><span class="o">(</span><span class="n">reporterConfig</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="k">implicit</span> <span class="k">val</span> <span class="n">io</span> <span class="k">=</span> <span class="nc">IOSystem</span><span class="o">(</span><span class="s">"badurl"</span><span class="o">,</span> <span class="nc">None</span><span class="o">,</span> <span class="n">metricSystem</span><span class="o">)</span>
  <span class="k">implicit</span> <span class="k">val</span> <span class="n">metricNamespace</span> <span class="k">=</span> <span class="n">io</span><span class="o">.</span><span class="n">metrics</span>

  <span class="k">val</span> <span class="n">badUrl</span> <span class="k">=</span> <span class="nc">Rate</span><span class="o">(</span><span class="s">"badurl"</span><span class="o">)</span>

  <span class="nc">Server</span><span class="o">.</span><span class="n">start</span><span class="o">(</span><span class="s">"hello-world"</span><span class="o">,</span> <span class="mi">9000</span><span class="o">){</span>
    <span class="n">worker</span> <span class="k">=&gt;</span> <span class="k">new</span> <span class="nc">Initializer</span><span class="o">(</span><span class="n">worker</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">def</span> <span class="n">onConnect</span> <span class="k">=</span> <span class="n">context</span> <span class="k">=&gt;</span> <span class="k">new</span> <span class="nc">HttpService</span><span class="o">(</span><span class="n">context</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">def</span> <span class="n">handle</span> <span class="k">=</span> <span class="o">{</span>
          <span class="k">case</span> <span class="n">request</span> <span class="k">@</span> <span class="nc">Get</span> <span class="n">on</span> <span class="nc">Root</span> <span class="o">/</span> <span class="s">"url"</span> <span class="k">=&gt;</span> <span class="o">{</span>

            <span class="c1">//bad url, metric tick
</span>            <span class="k">if</span><span class="o">(!</span><span class="n">request</span><span class="o">.</span><span class="n">head</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">contains</span><span class="o">(</span><span class="s">"myurl"</span><span class="o">))</span> <span class="o">{</span>
              <span class="n">badUrl</span><span class="o">.</span><span class="n">hit</span><span class="o">()</span>
            <span class="o">}</span>
            <span class="nc">Callback</span><span class="o">.</span><span class="n">successful</span><span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="n">ok</span><span class="o">(</span><span class="s">"received response"</span><span class="o">))</span>
          <span class="o">}</span>
        <span class="o">}</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>
  
  <span class="c1">//creates a stats url on 9001 that's visible to the client
</span>  <span class="n">serviceui</span><span class="o">.</span><span class="nc">UIServer</span><span class="o">.</span><span class="n">start</span><span class="o">(</span><span class="mi">9001</span><span class="o">)</span>
  </code></pre></figure>

<h2 id="available-collectors">Available Collectors</h2>

<p>All collectors are thread-safe.</p>

<h3 id="counter">Counter</h3>

<p>A counter simply allows you to set, increment, and decrement values:</p>

<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">val</span> <span class="n">counter</span> <span class="k">=</span> <span class="nc">Counter</span><span class="o">(</span><span class="s">"my-counter"</span><span class="o">)</span>

<span class="n">counter</span><span class="o">.</span><span class="n">set</span><span class="o">(</span><span class="nc">Map</span><span class="o">(</span><span class="s">"foo"</span> <span class="o">-&gt;</span> <span class="s">"bar"</span><span class="o">),</span> <span class="mi">2</span><span class="o">)</span>

<span class="n">counter</span><span class="o">.</span><span class="n">increment</span><span class="o">(</span><span class="nc">Map</span><span class="o">(</span><span class="s">"foo"</span> <span class="o">-&gt;</span> <span class="s">"bar"</span><span class="o">))</span></code></pre></figure>

<h3 id="rate">Rate</h3>

<p>A rate is like a counter, but resets at the beginning of each collection
interval.  Rates are also tracked for every interval.</p>

<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">val</span> <span class="n">rate</span> <span class="k">=</span> <span class="nc">Rate</span><span class="o">(</span><span class="s">"my-rate"</span><span class="o">)</span>

<span class="n">rate</span><span class="o">.</span><span class="n">hit</span><span class="o">()</span></code></pre></figure>

<h3 id="histogram">Histogram</h3>

<p>Histograms can gather statistical data about values added to them.  By default,
histograms are setup with various percentiles defined, the values are sorted
and placed in the appropriate percentiles.</p>

<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">val</span> <span class="n">hist</span> <span class="k">=</span> <span class="nc">Histogram</span><span class="o">(</span><span class="s">"my-histogram"</span><span class="o">,</span> <span class="n">percentiles</span> <span class="k">=</span> <span class="nc">List</span><span class="o">(</span><span class="mf">0.5</span><span class="o">,</span> <span class="mf">0.99</span><span class="o">,</span> <span class="mf">0.999</span><span class="o">))</span>

<span class="n">hist</span><span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="mi">12</span><span class="o">)</span>
<span class="n">hist</span><span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span>
<span class="n">hist</span><span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="mi">98765</span><span class="o">)</span></code></pre></figure>

<h2 id="metric-reporting">Metric Reporting</h2>

<p>Metric reporters are used to take the periodically generated snapshots of
metrics and report them to an external system.  A <code class="highlighter-rouge">MetricSender</code> is the
interface to the remote system and is responsible for properly formatting
metrics and handling all communication.  Colossus currently has native support
for OpenTSDB.</p>

<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">import</span> <span class="nn">akka.actor._</span>
<span class="k">import</span> <span class="nn">colossus.metrics._</span>
<span class="k">import</span> <span class="nn">scala.concurrent.duration._</span>

<span class="k">implicit</span> <span class="k">val</span> <span class="n">system</span> <span class="k">=</span> <span class="nc">ActorSystem</span><span class="o">()</span>
<span class="k">implicit</span> <span class="k">val</span> <span class="n">metrics</span> <span class="k">=</span> <span class="nc">MetricSystem</span><span class="o">(</span><span class="nc">MetricSystemConfig</span><span class="o">.</span><span class="n">load</span><span class="o">(</span><span class="s">"application"</span><span class="o">))</span>

<span class="k">val</span> <span class="n">reporterConfig</span> <span class="k">=</span> <span class="nc">MetricReporterConfig</span><span class="o">(</span>
  <span class="n">metricSenders</span> <span class="k">=</span> <span class="nc">Seq</span><span class="o">(</span><span class="nc">OpenTsdbSender</span><span class="o">(</span><span class="s">"host"</span><span class="o">,</span> <span class="mi">123</span><span class="o">)),</span>
  <span class="n">filters</span> <span class="k">=</span> <span class="nc">MetricReporterFilter</span><span class="o">.</span><span class="nc">All</span>
<span class="o">)</span>

<span class="c1">//A reporter must be attached to a specific collection interval.  
</span><span class="n">metrics</span><span class="o">.</span><span class="n">collectionIntervals</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="mf">1.</span><span class="n">minute</span><span class="o">).</span><span class="n">foreach</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">report</span><span class="o">(</span><span class="n">reporterConfig</span><span class="o">))</span>

<span class="c1">//now once per minute the value of this rate and any other metrics will be reported
</span><span class="k">val</span> <span class="n">rate</span> <span class="k">=</span> <span class="nc">Rate</span><span class="o">(</span><span class="s">"myrate"</span><span class="o">)</span></code></pre></figure>


        </article>
      </div>
      <div id="column">
        <div class="subnav">
          <ol class="toc"><li><a href="#introduction">Introduction</a></li><li><a href="#getting-started">Getting Started</a></li><li><a href="#available-collectors">Available Collectors</a></li><li><a href="#metric-reporting">Metric Reporting</a></li></ol>
        </div>
      </div>
      <br class="clear" />
    </div>
  </div>
  <br class="clear" />



    <footer id = "footer" class="site-footer">

<div class="wrapper col5">
  <div id="copyright">
    <p class="fl_left">Copyright &copy; 2016 Tumblr - All Rights Reserved <a rel="license" href="http://creativecommons.org/licenses/by/3.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by/3.0/80x15.png" /></a></p>
    <p class="fl_right">Based on a template by <a href="http://www.os-templates.com/" title="Free Website Templates">OS Templates</a></p>
    <br class="clear" />
  </div>
</div>

</footer>


    </body>
</html>
